# Архитектура платформы AutoLabs

## Дата обновления
2025-11-29

---

## 1. Общая информация

### Назначение платформы
Защищённая микросервисная платформа для управления лабораторными работами по информационной безопасности.

### Ключевые принципы
- Микросервисная архитектура
- Изоляция лабораторных окружений
- Гибкость конфигурации
- Универсальность развёртывания

---

## 2. Инфраструктура

### 2.1 Ресурсы
- **Kubernetes кластер**: 1 кластер (dev окружение)
- **CPU**: 12-24 cores
- **RAM**: 16-32 GB
- **Физическая инфраструктура**: Собственный сервер + возможность VPS расширения
- **Фокус**: Минимальное dev развёртывание (stage/prod - отложено)

### 2.2 Сетевая архитектура

```
Пользователь
    ↓
[Nginx (bare-metal)] ← SSL termination, внешний шлюз
    ↓
[Nginx Ingress Controller (K8s)] ← Внутренняя маршрутизация
    ↓
┌──────────────┬───────────────┬──────────────┬─────────────┐
│   Frontend   │   Backend     │   Backend    │   Zitadel   │
│              │  Платформенный│Инфраструктурный│            │
└──────────────┴───────────────┴──────────────┴─────────────┘
```

**Особенности:**
- Внешний Nginx (bare-metal): SSL termination, первичный роутинг
- Nginx Ingress Controller (K8s): Автоматическая маршрутизация внутри кластера
- Изоляция через Network Policies

---

## 3. Kubernetes архитектура

### 3.1 Namespace структура

```
k8s-cluster/
│
├── namespace: platform           # Платформенные сервисы
│   ├── deployment: frontend
│   ├── deployment: backend-platform (FastAPI)
│   └── service: backend-platform
│
├── namespace: infrastructure     # Инфраструктурные сервисы
│   ├── deployment: backend-infra (FastAPI)
│   ├── deployment: celery-worker
│   └── service: backend-infra
│
├── namespace: data               # Хранилища данных
│   ├── statefulset: postgresql
│   ├── statefulset: redis
│   ├── deployment: minio
│   └── services: postgres-svc, redis-svc, minio-svc
│
├── namespace: auth               # Авторизация
│   ├── deployment: zitadel
│   └── service: zitadel
│
├── namespace: messaging          # Очереди сообщений
│   ├── deployment: rabbitmq
│   └── service: rabbitmq
│
├── namespace: labs               # Динамические лабораторные работы
│   └── [динамически создаваемые поды]
│
└── namespace: ingress-nginx      # Ingress Controller
    └── deployment: nginx-ingress-controller
```

### 3.2 Межсервисное взаимодействие

**Изоляция по умолчанию:**
- Каждый namespace изолирован через Network Policies
- Разрешённые коммуникации настраиваются явно

**Доступ к данным:**
- `namespace: data` доступен с внешним доступом для администрирования
- Внутренний доступ только для `platform` и `infrastructure` namespaces

---

## 4. Микросервисы

### 4.1 Backend Платформенный (namespace: platform)

**Технологии:** FastAPI, Python

**Назначение:**
- API для взаимодействия пользователей с платформой
- Управление курсами, студентами, преподавателями
- Управление заданиями и лабораторными работами

**Функции:**
- CRUD операции над сущностями (курсы, студенты, группы)
- Валидация пользовательских данных
- Интеграция с Zitadel для авторизации
- Отправка запросов в Backend Инфраструктурный для запуска лабораторных работ

**Хранение данных:**
- PostgreSQL: метаданные курсов, пользователей, заданий
- Redis: кэш, сессии
- Minio: статичные файлы, изображения

### 4.2 Backend Инфраструктурный (namespace: infrastructure)

**Технологии:** FastAPI, Celery, Python

**Назначение:**
- Управление жизненным циклом лабораторных работ
- Взаимодействие с Kubernetes API
- Развёртывание и удаление изолированных окружений

**Функции:**
- Получение запросов на создание лабораторных работ
- Развёртывание подов/сервисов в namespace: labs
- Управление volumes для переиспользования
- Отправка статусов и учётных данных в RabbitMQ
- Мониторинг состояния запущенных лабораторных работ

**Хранение данных:**
- PostgreSQL: метаданные развёртываний, логи операций
- Minio: Docker образы, конфигурации лабораторных работ
- RabbitMQ: очередь задач для Celery, уведомления о статусах

### 4.3 Frontend (namespace: platform)

**Назначение:**
- Пользовательский интерфейс для студентов и преподавателей
- Взаимодействие с Backend Платформенным через REST API

### 4.4 Zitadel (namespace: auth)

**Технология:** Zitadel (https://github.com/zitadel/zitadel)

**Назначение:**
- Централизованная авторизация и аутентификация
- Управление пользователями, ролями, permissions
- OAuth2 / OIDC провайдер

**Интеграция:**
- Backend Платформенный валидирует JWT токены от Zitadel
- Frontend перенаправляет на Zitadel для логина

---

## 5. Хранилища данных (namespace: data)

### 5.1 PostgreSQL
- **Развёртывание:** StatefulSet
- **Назначение:** Основная реляционная БД
- **Использование:**
  - Метаданные платформы (курсы, студенты, задания)
  - Метаданные инфраструктуры (развёртывания, логи)
  - Zitadel database

### 5.2 Redis
- **Развёртывание:** StatefulSet
- **Назначение:** Кэш, сессии, очереди
- **Использование:**
  - Кэширование API ответов
  - Хранение пользовательских сессий
  - Celery broker (альтернатива)

### 5.3 Minio (S3-совместимое хранилище)
- **Развёртывание:** Deployment
- **Назначение:** Object storage
- **Использование:**
  - Конфигурации лабораторных работ (YAML, scripts)
  - Docker образы (если не используется внешний registry)
  - Статичные файлы (изображения, документы)
  - Volumes для переиспользования лабораторных работ

---

## 6. Очереди сообщений (namespace: messaging)

### 6.1 RabbitMQ
- **Развёртывание:** Deployment/StatefulSet
- **Назначение:** Message broker
- **Использование:**
  - Celery task queue для Backend Инфраструктурного
  - Отправка учётных данных и статусов для студентов
  - Асинхронные уведомления между сервисами

---

## 7. Лабораторные работы

### 7.1 Жизненный цикл лабораторной работы

1. **Создание конфигурации:**
   - Преподаватель загружает конфигурацию через Frontend
   - Конфигурация сохраняется в Minio
   - Метаданные сохраняются в PostgreSQL (через Backend Платформенный)

2. **Запуск лабораторной работы:**
   - Преподаватель инициирует запуск для группы студентов
   - Backend Платформенный отправляет запрос в Backend Инфраструктурный
   - Запросы помещаются в очередь RabbitMQ

3. **Развёртывание:**
   - Celery worker (Backend Инфраструктурный) обрабатывает задачу
   - Создаются поды в namespace: labs
   - Настраиваются сервисы, volumes, network policies

4. **Доступ для студентов:**
   - Учётные данные (IP, порты, credentials) отправляются в RabbitMQ
   - Студенты получают информацию через Frontend
   - Подключение через SSH (или web-терминал)

5. **Завершение:**
   - Преподаватель останавливает лабу или срабатывает таймер
   - Volumes сохраняются в Minio (если многократное использование)
   - Поды удаляются

### 7.2 Режимы развёртывания лабораторных работ

Платформа поддерживает гибкие конфигурации:

| Режим | Описание | Изоляция |
|-------|----------|----------|
| **1 контейнер на группу** | Все студенты группы работают в одном контейнере | Общие ресурсы |
| **1 контейнер на студента** | Каждый студент получает изолированный контейнер | Полная изоляция |
| **Несколько контейнеров на студента (изолированная сеть)** | Студент работает с несколькими контейнерами в собственной сети | Изоляция между студентами |
| **Общая сеть для всех** | Все контейнеры в одной сети (для сетевых лабораторных) | Общая сеть |

### 7.3 Изоляция и безопасность

**Сетевая изоляция:**
- Каждая лабораторная работа изолирована через Kubernetes Network Policies
- Доступ в интернет: переключаемый (настраивается в конфигурации)
- По умолчанию: запрещён доступ к namespace: platform, data, auth

**Доступ для студентов:**
- **Предпочтительно:** SSH (гибкое решение, подходит для разных типов лаб)
- **Альтернатива:** Web-терминал (для упрощённого доступа через браузер)

### 7.4 Переиспользование volumes

- При многократном использовании лабораторной работы volumes сохраняются
- Хранение: Minio (архивация) или PersistentVolumes (быстрый доступ)
- При повторном запуске volumes восстанавливаются

---

## 8. CI/CD

### 8.1 GitLab
- **Расположение:** Собственный GitLab (внутри или вне K8s - обсуждается)
- **GitLab Runner:** Интеграция с Kubernetes для деплоя

### 8.2 Docker Registry
- **Варианты:** GitLab Container Registry, Harbor, или Minio

---

## 9. Внешний доступ

### 9.1 Доменные имена и IP адреса
- **Принцип:** Универсальное решение, настраиваемое через переменные окружения
- **Настройка:** Через внешний Nginx (bare-metal)
- **Kubernetes:** Не имеет прямого знания о внешних доменах/IP

### 9.2 SSL/TLS
- **SSL termination:** На внешнем Nginx (bare-metal)
- **Сертификаты:** Настраиваемые (Let's Encrypt, самоподписанные)

---

## 10. Мониторинг (опционально, для будущего)

### namespace: monitoring
- Prometheus: сбор метрик
- Grafana: визуализация
- AlertManager: уведомления

---

## Приоритеты разработки

**Фаза 1 (MVP - текущий фокус):**
- ✅ Один K8s кластер
- ✅ Dev окружение
- ✅ Минимальный набор namespace
- ✅ Базовая функциональность запуска лабораторных работ

**Фаза 2 (будущее):**
- Stage/Prod окружения
- Раздельные кластеры данных
- Масштабирование
- Полноценный мониторинг

---

## Глоссарий

| Термин | Описание |
|--------|----------|
| **Backend Платформенный** | API для взаимодействия пользователей с платформой |
| **Backend Инфраструктурный** | Сервис управления развёртываниями в K8s |
| **Zitadel** | Современный CNCF IAM сервис (замена Keycloak) |
| **Namespace** | Логическая изоляция ресурсов внутри K8s кластера |
| **Pod** | Минимальная единица развёртывания в K8s (один или несколько контейнеров) |
| **Service** | Стабильный endpoint для доступа к подам |
| **Ingress** | HTTP/HTTPS маршрутизация внутрь кластера |
| **StatefulSet** | K8s ресурс для stateful приложений (БД) |
| **PersistentVolume** | Постоянное хранилище данных в K8s |
